{% extends "user_base.html" %}
{% load static %}

{% block content %}

<section class="mt-50 mb-50">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="product-detail accordion-detail">
                    <div class="row mb-50">
                        <div class="col-md-6 col-sm-12 col-xs-12">
                            <div class="detail-gallery">
                                <span class="zoom-icon"><i class="fi-rs-search"></i></span>
                                <!-- MAIN SLIDES -->
                                <div class="product-image-slider">
                                    <figure class="border-radius-10">
                                        <img src="{{ product.product_img1.url }}" alt="{{ product.product_name }} - Main Image">
                                    </figure>
                                    {% if product.product_img2 %}
                                    <figure class="border-radius-10">
                                        <img src="{{ product.product_img2.url }}" alt="{{ product.product_name }} - Image 2">
                                    </figure>
                                    {% endif %}
                                    {% if product.product_img3 %}
                                    <figure class="border-radius-10">
                                        <img src="{{ product.product_img3.url }}" alt="{{ product.product_name }} - Image 3">
                                    </figure>
                                    {% endif %}
                                </div>
                                <!-- THUMBNAILS -->
                                <div class="slider-nav-thumbnails pl-15 pr-15">
                                    <div><img src="{{ product.product_img1.url }}" alt="{{ product.product_name }} thumbnail"></div>
                                    {% if product.product_img2 %}
                                    <div><img src="{{ product.product_img2.url }}" alt="{{ product.product_name }} thumbnail"></div>
                                    {% endif %}
                                    {% if product.product_img3 %}
                                    <div><img src="{{ product.product_img3.url }}" alt="{{ product.product_name }} thumbnail"></div>
                                    {% endif %}
                                </div>
                            </div>
                            <!-- End Gallery -->
                        </div>
                        <div class="col-md-6 col-sm-12 col-xs-12">
                            <div class="detail-info">
                                <h1 class="title-detail">{{ product.product_name }}</h1>
                                
                                <!-- Brand and Category Info -->
                                <div class="product-detail-info mb-3">
                                    <div class="pro-details-brand">
                                        <span><strong>Brand:</strong> {{ product.brand }}</span>
                                        <span class="ml-3"><strong>Category:</strong> <a href="#">{{ product.category }}</a></span>
                                    </div>
                                </div>

                                <!-- Price Section -->
                                <div class="clearfix product-price-cover mb-3">
                                    <div class="product-price primary-color float-left">
                                        <span class="price-label"><strong>Price:</strong></span>
                                        <ins class="discounted-price bold-text unique-color">₹{{ product.offer_price }}</ins>
                                        {% if product.original_price and product.original_price != product.offer_price %}
                                            <del class="old-price font-md ml-15">₹{{ product.original_price }}</del>
                                            <span class="save-price font-md offer-color ml-15">
                                                {% with best_offer=product.get_best_offer %}
                                                    {% if best_offer %}
                                                        <span class="badge badge-success">{{ best_offer.percentage }}% Off</span>
                                                    {% endif %}
                                                {% endwith %}
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="bt-1 border-color-1 mt-15 mb-15"></div>

                                <!-- Product Benefits -->
                                <div class="product_sort_info font-xs mb-30">
                                    <ul>
                                        <li class="mb-10"><i class="fi-rs-crown mr-5 text-success"></i> <strong>1 Year AL Jazeera Brand Warranty</strong></li>
                                        <li class="mb-10"><i class="fi-rs-refresh mr-5 text-info"></i> <strong>30 Day Return Policy</strong></li>
                                        <li><i class="fi-rs-credit-card mr-5 text-warning"></i> <strong>Cash on Delivery Available</strong></li>
                                    </ul>
                                </div>

                                <!-- Size Selection and Stock Information -->
                                <form method="post" action="{% url 'add_to_cart' product.id %}">
                                    {% csrf_token %}
                                    <input type="hidden" name="quantity" id="quantity-input" value="0">

                                    <div class="mb-4">
                                        <h5><strong>Available Sizes & Stock:</strong></h5>
                                        <div class="size-stock-info mb-3">
                                            {% for size_info in sizes_with_quantities %}
                                                <div class="size-option mb-2 p-2 border rounded" style="{% if size_info.quantity == 0 %}background-color: #f8f9fa; opacity: 0.7;{% endif %}">
                                                    <div class="form-check">
                                                        <input type="radio" 
                                                               class="form-check-input size-checkbox" 
                                                               name="size" 
                                                               id="size-{{ size_info.size.id }}" 
                                                               value="{{ size_info.size.id }}" 
                                                               {% if size_info.quantity == 0 %}disabled{% endif %}
                                                               autocomplete="off">
                                                        <label class="form-check-label d-flex justify-content-between align-items-center w-100" for="size-{{ size_info.size.id }}">
                                                            <span><strong>Size {{ size_info.size.name }}</strong></span>
                                                            <span class="{% if size_info.quantity == 0 %}text-danger{% else %}text-success{% endif %}">
                                                                {% if size_info.quantity == 0 %}
                                                                    <i class="fi-rs-cross-small"></i> Out of Stock
                                                                {% elif size_info.quantity <= 5 %}
                                                                    <i class="fi-rs-exclamation"></i> Only {{ size_info.quantity }} left
                                                                {% else %}
                                                                    <i class="fi-rs-check"></i> {{ size_info.quantity }} in stock
                                                                {% endif %}
                                                            </span>
                                                        </label>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                        
                                        <!-- Size Selection Helper Text -->
                                        <small class="text-muted">
                                            <i class="fi-rs-info mr-1"></i>
                                            Please select a size to add to cart. Stock levels are updated in real-time.
                                        </small>
                                    </div>

                                    <!-- Messages Display -->
                                    {% for message in messages %}
                                        <div class="alert alert-info alert-dismissible fade show" role="alert">
                                            {{ message }}
                                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                        </div>
                                    {% endfor %}

                                    <div class="bt-1 border-color-1 mt-30 mb-30"></div>

                                    <!-- Quantity and Add to Cart -->
                                    <div class="detail-extralink">
                                        <div class="detail-qty border radius">
                                            <a href="#" class="qty-down"><i class="fi-rs-angle-small-down"></i></a>
                                            <span class="qty-val">0</span>
                                            <a href="#" class="qty-up"><i class="fi-rs-angle-small-up"></i></a>
                                        </div>

                                        <div class="product-extra-link2">
                                            <button type="submit" class="button button-add-to-cart" id="add-to-cart-btn" disabled>
                                                <i class="fi-rs-shopping-cart mr-5"></i>
                                                Select Size to Add to Cart
                                            </button>
                                        </div>
                                    </div>
                                </form>

                                <!-- jQuery CDN -->
                                <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

                                <script>
                                (function () {
                                    'use strict';

                                    $(document).ready(function () {
                                        const addToCartBtn = $('#add-to-cart-btn');
                                        const qtyVal = $('.qty-val');
                                        const quantityInput = $('#quantity-input');
                                        const sizeCheckboxes = $('.size-checkbox');
                                        const qtyUp = $('.qty-up');
                                        const qtyDown = $('.qty-down');
                                        const detailExtraLink = $('.detail-extralink');

                                        // Store stock for each size
                                        const sizeStock = {
                                            {% for size_info in sizes_with_quantities %}
                                            '{{ size_info.size.id }}': {{ size_info.quantity }},
                                            {% endfor %}
                                        };

                                        function getSelectedSizeStock() {
                                            const selectedSize = sizeCheckboxes.filter(':checked').val();
                                            return selectedSize ? sizeStock[selectedSize] : 0;
                                        }

                                        function updateQuantityAndButton(quantity) {
                                            qtyVal.text(quantity);
                                            quantityInput.val(quantity);
                                            const stock = getSelectedSizeStock();
                                            if (quantity > 0 && quantity <= stock) {
                                                addToCartBtn.html(`<i class="fi-rs-shopping-cart mr-5"></i>Add ${quantity} to Cart`);
                                            }
                                        }

                                        function updateQuantityControls() {
                                            const currentQty = parseInt(qtyVal.text());
                                            const stock = getSelectedSizeStock();

                                            qtyDown.toggleClass('disabled', currentQty <= 1).css('opacity', currentQty <= 1 ? '0.5' : '1');
                                            qtyUp.toggleClass('disabled', currentQty >= stock).css('opacity', currentQty >= stock ? '0.5' : '1');
                                        }

                                        function showStockAlert(message) {
                                            $('.stock-alert').remove();
                                            const alertHtml = `
                                                <div class="alert alert-warning alert-dismissible fade show stock-alert" role="alert">
                                                    <i class="fi-rs-exclamation mr-2"></i>${message}
                                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                                </div>
                                            `;
                                            detailExtraLink.before(alertHtml);
                                            setTimeout(() => $('.stock-alert').fadeOut(), 3000);
                                        }

                                        sizeCheckboxes.on('change', function () {
                                            if ($(this).is(':checked')) {
                                                const stock = getSelectedSizeStock();
                                                if (stock > 0) {
                                                    updateQuantityAndButton(1);
                                                    updateQuantityControls();
                                                    addToCartBtn.prop('disabled', false)
                                                        .html('<i class="fi-rs-shopping-cart mr-5"></i>Add to Cart');
                                                } else {
                                                    addToCartBtn.prop('disabled', true)
                                                        .html('<i class="fi-rs-shopping-cart mr-5"></i>Out of Stock');
                                                    updateQuantityAndButton(0);
                                                }
                                            }
                                        });

                                        qtyUp.on('click', function (e) {
                                            e.preventDefault();
                                            const currentQty = parseInt(qtyVal.text());
                                            const stock = getSelectedSizeStock();
                                            if (currentQty < stock) {
                                                updateQuantityAndButton(currentQty + 1);
                                                updateQuantityControls();
                                            } else {
                                                showStockAlert(`Only ${stock} items available in stock!`);
                                            }
                                        });

                                        qtyDown.on('click', function (e) {
                                            e.preventDefault();
                                            const currentQty = parseInt(qtyVal.text());
                                            if (currentQty > 1) {
                                                updateQuantityAndButton(currentQty - 1);
                                                updateQuantityControls();
                                            }
                                        });

                                        $('form').on('submit', function (e) {
                                            const selected = sizeCheckboxes.filter(':checked');
                                            if (!selected.length) {
                                                e.preventDefault();
                                                showStockAlert('Please select a size before adding to cart.');
                                                return false;
                                            }

                                            const qty = parseInt(quantityInput.val());
                                            const stock = getSelectedSizeStock();

                                            if (qty > stock) {
                                                e.preventDefault();
                                                showStockAlert(`Cannot add ${qty} items. Only ${stock} available.`);
                                                return false;
                                            }

                                            if (qty < 1) {
                                                e.preventDefault();
                                                showStockAlert('Quantity must be at least 1.');
                                                return false;
                                            }
                                        });

                                        // Init
                                        updateQuantityAndButton(0);
                                        updateQuantityControls();
                                        addToCartBtn.prop('disabled', true);
                                    });
                                })();
                                </script>




                                <!-- Product Meta Information -->
                                <ul class="product-meta font-xs color-grey mt-50">
                                    <li class="mb-5"><strong>SKU:</strong> <span class="text-muted">{{ product.sku|default:"FWM15VKT" }}</span></li>
                                    <li class="mb-5"><strong>Tags:</strong> 
                                        <a href="#" rel="tag" class="badge badge-light mr-1">{{ product.category }}</a>
                                        <a href="#" rel="tag" class="badge badge-light mr-1">{{ product.brand }}</a>
                                    </li>
                                    <li class="mb-5"><strong>Availability:</strong> 
                                        <span class="text-success">
                                            <i class="fi-rs-check-circle mr-1"></i>
                                            {% if sizes_with_quantities|length > 0 %}In Stock{% else %}Contact for Availability{% endif %}
                                        </span>
                                    </li>
                                </ul>
                            </div>
                            <!-- Detail Info -->
                        </div>
                    </div>

                    <!-- Product Description Section -->
                    <div class="row">
                        <div class="col-lg-10 m-auto entry-main-content">
                            <h2 class="section-title style-1 mb-30">Product Description</h2>
                            <div class="description mb-50">
                                <div class="product-description-content">
                                    {% if product.product_description %}
                                        <p class="lead">{{ product.product_description }}</p>
                                    {% else %}
                                        <p class="lead">Experience premium quality with {{ product.product_name }} from {{ product.brand }}. This carefully crafted product combines style, comfort, and durability to meet your everyday needs.</p>
                                    {% endif %}
                                </div>

                                <!-- Key Features -->
                                <div class="key-features mt-4 mb-4">
                                    <h4>Key Features:</h4>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <ul class="feature-list">
                                                <li><i class="fi-rs-check text-success mr-2"></i>Premium {{ product.brand }} Quality</li>
                                                <li><i class="fi-rs-check text-success mr-2"></i>Multiple Size Options Available</li>
                                                <li><i class="fi-rs-check text-success mr-2"></i>1 Year Warranty Included</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-6">
                                            <ul class="feature-list">
                                                <li><i class="fi-rs-check text-success mr-2"></i>30-Day Return Policy</li>
                                                <li><i class="fi-rs-check text-success mr-2"></i>Cash on Delivery Available</li>
                                                <li><i class="fi-rs-check text-success mr-2"></i>Fast & Secure Shipping</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Product Information -->
                    <div class="row">
                        <div class="col-lg-10 m-auto">
                            <h3 class="section-title style-1 mb-30">Product Specifications</h3>
                            <div class="row">
                                <div class="col-md-6">
                                    <table class="table table-bordered font-md mb-30">
                                        <tbody>
                                            <tr>
                                                <th width="40%">Brand</th>
                                                <td>{{ product.brand }}</td>
                                            </tr>
                                            <tr>
                                                <th>Category</th>
                                                <td>{{ product.category }}</td>
                                            </tr>
                                            <tr>
                                                <th>Available Sizes</th>
                                                <td>
                                                    {% for size_info in sizes_with_quantities %}
                                                        <span class="badge {% if size_info.quantity > 0 %}badge-success{% else %}badge-secondary{% endif %} mr-1">
                                                            {{ size_info.size.name }}
                                                        </span>
                                                    {% endfor %}
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>Warranty</th>
                                                <td>1 Year Brand Warranty</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <div class="shipping-info p-4 bg-light rounded">
                                        <h5><i class="fi-rs-truck mr-2 text-primary"></i>Shipping & Delivery</h5>
                                        <ul class="list-unstyled mt-3">
                                            <li class="mb-2"><i class="fi-rs-check text-success mr-2"></i>Free shipping on orders above ₹500</li>
                                            <li class="mb-2"><i class="fi-rs-check text-success mr-2"></i>Standard delivery: 3-5 business days</li>
                                            <li class="mb-2"><i class="fi-rs-check text-success mr-2"></i>Express delivery available</li>
                                            <li class="mb-2"><i class="fi-rs-check text-success mr-2"></i>Cash on delivery accepted</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Social Share -->
                    <div class="row mt-4">
                        <div class="col-lg-10 m-auto">
                            <div class="social-icons single-share">
                                <ul class="text-grey-5 d-inline-block">
                                    <li><strong class="mr-10">Share this product:</strong></li>
                                    <li class="social-facebook"><a href="#" title="Share on Facebook"><img src="{% static 'user/assets/imgs/theme/icons/icon-facebook.svg'%}" alt="Facebook"></a></li>
                                    <li class="social-twitter"><a href="#" title="Share on Twitter"><img src="{% static 'user/assets/imgs/theme/icons/icon-twitter.svg'%}" alt="Twitter"></a></li>
                                    <li class="social-instagram"><a href="#" title="Share on Instagram"><img src="{% static 'user/assets/imgs/theme/icons/icon-instagram.svg'%}" alt="Instagram"></a></li>
                                    <li class="social-linkedin"><a href="#" title="Share on Pinterest"><img src="{% static 'user/assets/imgs/theme/icons/icon-pinterest.svg'%}" alt="Pinterest"></a></li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Related Products Section -->
                    <div class="row mt-60">
                        <div class="col-12">
                            <h3 class="section-title style-1 mb-30">You Might Also Like</h3>
                        </div>
                        <div class="col-12">
                            <div class="row related-products">
                                {% for related_product in related_products %}
                                <div class="col-lg-3 col-md-4 col-12 col-sm-6 mb-4">
                                    <div class="card h-100 product-cart-wrap small hover-up">
                                        <div class="product-img-action-wrap">
                                            <div class="product-img product-img-zoom">
                                                <a href="{% url 'product_detials' related_product.id %}" tabindex="0">
                                                    <img class="card-img-top img-fluid" src="{{ related_product.product_img1.url }}" alt="{{ related_product.product_name }}" style="height: 300px; object-fit: cover;">
                                                </a>
                                            </div>
                                            <div class="product-badges product-badges-position product-badges-mrg">
                                                {% with related_best_offer=related_product.get_best_offer %}
                                                    {% if related_best_offer %}
                                                        <span class="badge badge-success">{{ related_best_offer.percentage }}% Off</span>
                                                    {% endif %}
                                                {% endwith %}
                                            </div>
                                        </div>
                                        <div class="card-body product-content-wrap">
                                            <h2 class="card-title">
                                                <a href="{% url 'product_detials' related_product.id %}" tabindex="0">
                                                    {{ related_product.product_name|truncatechars:50 }}
                                                </a>
                                            </h2>
                                            <p class="card-text product-price">
                                                <span class="text-primary font-weight-bold">₹{{ related_product.offer_price }}</span>
                                                {% if related_product.original_price and related_product.original_price != related_product.offer_price %}
                                                <span class="old-price text-muted ml-2">₹{{ related_product.original_price }}</span>
                                                {% endif %}
                                            </p>
                                            <div class="product-action mt-2">
                                                <a href="{% url 'add_wishlist' product.id %}?next={{ request.path }}" class="btn btn-outline-danger btn-sm">
                                                    <i class="fi-rs-heart"></i> Wishlist
                                                </a>
                                                <a href="{% url 'product_detials' related_product.id %}" class="btn btn-primary btn-sm ml-2">
                                                    View Details
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Service Banner -->
                <div class="banner-img banner-big wow fadeIn f-none animated mt-50">
                    <img class="border-radius-10" src="{% static 'user/assets/imgs/banner/banner-4.png' %}" alt="Repair Services Banner">
                    <div class="banner-text">
                        <h4 class="mb-15 mt-40">Professional Services</h4>
                        <h2 class="fw-600 mb-20">We're an Authorized <br>Service Provider</h2>
                        <p class="mb-3">Expert repair and maintenance services for all your products</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

{% endblock content %}